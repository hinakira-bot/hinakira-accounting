<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hinakira会計 - 管理者ダッシュボード</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="style.css?v=41">
    <style>
        body { background: var(--bg); color: var(--text); font-family: var(--font); margin: 0; padding: 0; }
        .admin-header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .admin-header h1 { font-size: 1.2rem; margin: 0; }
        .admin-container { max-width: 960px; margin: 2rem auto; padding: 0 1rem; }
        .admin-section { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; }
        .admin-section h2 { margin-top: 0; font-size: 1.1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        .gen-form { display: flex; gap: 0.75rem; align-items: flex-end; flex-wrap: wrap; }
        .gen-form label { font-size: 0.85rem; color: var(--text-dim); display: block; margin-bottom: 0.25rem; }
        .gen-form input { padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem; }
        .gen-form input[type="number"] { width: 80px; }
        .gen-form input[type="text"] { width: 200px; }
        .gen-results { margin-top: 1rem; }
        .gen-key { font-family: monospace; font-size: 1rem; background: var(--bg); padding: 0.4rem 0.75rem; border-radius: var(--radius); display: inline-block; margin: 0.25rem 0; cursor: pointer; border: 1px solid var(--border); }
        .gen-key:hover { border-color: var(--primary); }
        .gen-key.copied { background: #d4edda; border-color: #28a745; }
        .license-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .license-table th, .license-table td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
        .license-table th { background: var(--bg); font-weight: 600; position: sticky; top: 0; }
        .status-unused { color: var(--text-dim); }
        .status-copied { color: #e67e22; font-weight: 600; }
        .status-active { color: #28a745; font-weight: 600; }
        .status-revoked { color: #dc3545; text-decoration: line-through; }
        .btn-revoke { padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #dc3545; color: #fff; border: none; border-radius: var(--radius); cursor: pointer; }
        .btn-revoke:hover { background: #c82333; }
        .btn-unmark { padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #6c757d; color: #fff; border: none; border-radius: var(--radius); cursor: pointer; margin-left: 0.25rem; }
        .btn-unmark:hover { background: #5a6268; }
        .admin-login { text-align: center; margin-top: 4rem; }
        .admin-login p { color: var(--text-dim); margin-bottom: 1rem; }
        .admin-error { text-align: center; margin-top: 4rem; color: #dc3545; }
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: #333; color: #fff; padding: 0.75rem 1.5rem; border-radius: var(--radius); z-index: 9999; opacity: 0; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
    </style>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div id="admin-login" class="admin-login">
        <h2>管理者ダッシュボード</h2>
        <p>管理者アカウントでログインしてください</p>
        <button id="admin-login-btn" class="btn btn-primary">Googleでログイン</button>
    </div>

    <div id="admin-error" class="admin-error" style="display:none;">
        <h2>アクセス拒否</h2>
        <p>管理者権限がありません。</p>
        <button id="admin-retry-btn" class="btn btn-ghost" style="margin-top:1rem;">別のアカウントでログイン</button>
    </div>

    <div id="admin-app" style="display:none;">
        <div class="admin-header">
            <h1>Hinakira会計 管理者ダッシュボード</h1>
            <div>
                <span id="admin-user" style="font-size:0.85rem; color:var(--text-dim); margin-right:1rem;"></span>
                <button id="admin-logout-btn" class="btn btn-ghost" style="padding:0.3rem 0.75rem; font-size:0.8rem;">ログアウト</button>
            </div>
        </div>

        <div class="admin-container">
            <!-- Key Generation -->
            <div class="admin-section">
                <h2>ライセンスキー生成</h2>
                <div class="gen-form">
                    <div>
                        <label>生成数</label>
                        <input type="number" id="gen-count" value="1" min="1" max="100">
                    </div>
                    <div>
                        <label>メモ（任意）</label>
                        <input type="text" id="gen-notes" placeholder="例: 初期販売用">
                    </div>
                    <button id="gen-btn" class="btn btn-primary">生成</button>
                </div>
                <div id="gen-results" class="gen-results"></div>
            </div>

            <!-- License List -->
            <div class="admin-section">
                <h2>ライセンス一覧</h2>
                <div style="overflow-x:auto;">
                    <table class="license-table">
                        <thead>
                            <tr>
                                <th>ライセンスキー</th>
                                <th>ステータス</th>
                                <th>利用者</th>
                                <th>有効化日</th>
                                <th>メモ</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="licenses-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
    (function() {
        const CLIENT_ID = '353694435064-r6mlbk3mm2mflhl2mot2n94dpuactscc.apps.googleusercontent.com';
        let accessToken = null;
        let tokenClient = null;

        const loginDiv = document.getElementById('admin-login');
        const errorDiv = document.getElementById('admin-error');
        const appDiv = document.getElementById('admin-app');
        const toastEl = document.getElementById('toast');

        // Track copied (shared) license keys in localStorage
        function getCopiedKeys() {
            try { return JSON.parse(localStorage.getItem('hinakira_copied_keys') || '[]'); } catch { return []; }
        }
        function markKeyCopied(keyId) {
            const keys = getCopiedKeys();
            if (!keys.includes(keyId)) { keys.push(keyId); localStorage.setItem('hinakira_copied_keys', JSON.stringify(keys)); }
        }
        function unmarkKeyCopied(keyId) {
            const keys = getCopiedKeys().filter(k => k !== keyId);
            localStorage.setItem('hinakira_copied_keys', JSON.stringify(keys));
        }
        function isKeyCopied(keyId) {
            return getCopiedKeys().includes(keyId);
        }

        function showToast(msg) {
            toastEl.textContent = msg;
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), 2500);
        }

        async function fetchAdmin(url, method = 'GET', body = null) {
            const opts = { method, headers: { 'Authorization': 'Bearer ' + accessToken }, cache: 'no-store' };
            if (body) {
                opts.headers['Content-Type'] = 'application/json';
                opts.body = JSON.stringify(body);
            }
            const res = await fetch(url, opts);
            if (res.status === 401) {
                loginDiv.style.display = '';
                appDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                throw new Error('Unauthorized');
            }
            if (res.status === 403) {
                loginDiv.style.display = 'none';
                appDiv.style.display = 'none';
                errorDiv.style.display = '';
                throw new Error('Forbidden');
            }
            return res.json();
        }

        async function loadLicenses() {
            try {
                const data = await fetchAdmin('/api/admin/licenses');
                const tbody = document.getElementById('licenses-tbody');
                tbody.innerHTML = '';
                data.forEach(lic => {
                    const tr = document.createElement('tr');
                    let status, statusClass;
                    const copied = isKeyCopied(lic.id);
                    if (lic.is_revoked) {
                        status = '無効化';
                        statusClass = 'status-revoked';
                    } else if (lic.user_email) {
                        status = '有効';
                        statusClass = 'status-active';
                    } else if (copied) {
                        status = 'コピー済み';
                        statusClass = 'status-copied';
                    } else {
                        status = '未使用';
                        statusClass = 'status-unused';
                    }

                    // Actions column
                    let actions = '';
                    if (lic.is_revoked) {
                        actions = '-';
                    } else if (lic.user_email) {
                        actions = '<button class="btn-revoke" data-id="' + lic.id + '">無効化</button>';
                    } else if (copied) {
                        actions = '<button class="btn-unmark" data-id="' + lic.id + '">解除</button>'
                            + '<button class="btn-revoke" data-id="' + lic.id + '">無効化</button>';
                    } else {
                        actions = '<button class="btn-revoke" data-id="' + lic.id + '">無効化</button>';
                    }

                    tr.innerHTML = `
                        <td><span class="gen-key copy-key" data-key="${lic.license_key}" data-id="${lic.id}">${lic.license_key}</span></td>
                        <td><span class="${statusClass}">${status}</span></td>
                        <td>${lic.user_email || '-'}</td>
                        <td>${lic.activated_at ? new Date(lic.activated_at).toLocaleDateString('ja-JP') : '-'}</td>
                        <td>${lic.notes || '-'}</td>
                        <td>${actions}</td>
                    `;
                    tbody.appendChild(tr);
                });

                // Copy key handlers — mark as copied
                tbody.querySelectorAll('.copy-key').forEach(span => {
                    span.addEventListener('click', () => {
                        const key = span.dataset.key;
                        const keyId = parseInt(span.dataset.id);
                        navigator.clipboard.writeText(key).then(() => {
                            span.classList.add('copied');
                            markKeyCopied(keyId);
                            showToast('コピーしました: ' + key);
                            loadLicenses(); // Refresh to show "コピー済み"
                        });
                    });
                });

                // Unmark (解除) handlers
                tbody.querySelectorAll('.btn-unmark').forEach(btn => {
                    btn.addEventListener('click', () => {
                        unmarkKeyCopied(parseInt(btn.dataset.id));
                        showToast('コピー済みを解除しました');
                        loadLicenses();
                    });
                });

                // Revoke handlers
                tbody.querySelectorAll('.btn-revoke').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (!confirm('このライセンスを無効化しますか？')) return;
                        const keyId = parseInt(btn.dataset.id);
                        await fetchAdmin('/api/admin/licenses/revoke', 'POST', { license_key_id: keyId });
                        unmarkKeyCopied(keyId); // Also clear copied state
                        showToast('ライセンスを無効化しました');
                        loadLicenses();
                    });
                });
            } catch (e) {
                console.error('Load licenses error:', e);
            }
        }

        async function onAdminLogin(token) {
            accessToken = token;
            try {
                const me = await fetchAdmin('/api/me');
                document.getElementById('admin-user').textContent = me.email || '';
                // Try to access admin API to verify admin rights
                await fetchAdmin('/api/admin/licenses');
                loginDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                appDiv.style.display = '';
                loadLicenses();
            } catch (e) {
                // fetchAdmin already handles 403
            }
        }

        // Google OAuth init
        function initGoogleAuth() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'openid email profile',
                callback: (resp) => {
                    if (resp.access_token) {
                        onAdminLogin(resp.access_token);
                    }
                }
            });
        }

        // Wait for Google script to load
        const gsiCheck = setInterval(() => {
            if (window.google && google.accounts) {
                clearInterval(gsiCheck);
                initGoogleAuth();
            }
        }, 200);

        document.getElementById('admin-login-btn').addEventListener('click', () => {
            if (tokenClient) tokenClient.requestAccessToken();
        });
        document.getElementById('admin-retry-btn').addEventListener('click', () => {
            errorDiv.style.display = 'none';
            loginDiv.style.display = '';
            if (tokenClient) tokenClient.requestAccessToken();
        });
        document.getElementById('admin-logout-btn').addEventListener('click', () => {
            accessToken = null;
            appDiv.style.display = 'none';
            loginDiv.style.display = '';
        });

        // Generate keys
        document.getElementById('gen-btn').addEventListener('click', async () => {
            const count = parseInt(document.getElementById('gen-count').value) || 1;
            const notes = document.getElementById('gen-notes').value.trim();
            const btn = document.getElementById('gen-btn');
            btn.disabled = true;
            btn.textContent = '生成中...';
            try {
                const results = await fetchAdmin('/api/admin/licenses/generate', 'POST', { count, notes });
                const div = document.getElementById('gen-results');
                div.innerHTML = '<p style="font-size:0.85rem; color:var(--text-dim); margin-bottom:0.5rem;">クリックでコピー:</p>';
                results.forEach(r => {
                    if (r.license_key) {
                        const span = document.createElement('span');
                        span.className = 'gen-key';
                        span.textContent = r.license_key;
                        span.onclick = () => {
                            navigator.clipboard.writeText(r.license_key).then(() => {
                                span.classList.add('copied');
                                if (r.id) markKeyCopied(r.id);
                                showToast('コピーしました: ' + r.license_key);
                                loadLicenses(); // Refresh list to show "コピー済み"
                            });
                        };
                        div.appendChild(span);
                        div.appendChild(document.createElement('br'));
                    }
                });
                loadLicenses();
            } catch (e) {
                showToast('生成エラー');
            } finally {
                btn.disabled = false;
                btn.textContent = '生成';
            }
        });
    })();
    </script>
</body>
</html>
